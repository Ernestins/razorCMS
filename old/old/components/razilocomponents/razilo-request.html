<dom-module id="razilo-request">
	<template>
		<style>
			:host { display: none !important; }
		</style>
	</template>

	<script>
		class RaziloRequest extends Polymer.Element {
			static get is() { return "razilo-request"; }

			static get properties() {
				return {
					scheme: { type: String, value: 'http' },
					baseUrl: { type: String, value: null },
					id: { type: String, value: null }
				}
			}

			_createEndPoint(endPoint) {
				return (this.scheme == 'http' || this.scheme == 'htts' ? this.scheme : 'http') + '://' + this.baseUrl.replace(/^\/|\/$/g, '') + endPoint;
			}

			ajax(type, url, data, headers) {
				var scope = this;
				type = type.toUpperCase();
				var promise = new Promise(function(resolve, reject)
				{
					var XHR = XMLHttpRequest || ActiveXObject;
					var xhrRequest = new XHR('MSXML2.XMLHTTP.3.0');
					xhrRequest.open(type, url, true);
					if (typeof headers !== 'undefined') {
	                    if (scope.getToken()) headers.Authorization = 'Bearer ' + scope.getToken();
						for (var key in headers) xhrRequest.setRequestHeader(key, headers[key]);
					}

					xhrRequest.onreadystatechange = function ()
					{
						if (xhrRequest.readyState === 4)
						{
							// sort out response, sniff out json and convert
							var output = xhrRequest.responseText;
							if (typeof headers['Content-Type'] !== 'undefined' && headers['Content-Type'].indexOf('json') >= 0)
							{
								try { output = JSON.parse(xhrRequest.responseText); }
								catch(e) {}
							}

							// if authorization save to localStorage to resend back in
							if (!!this.getResponseHeader('Authorization')) scope.setToken(this.getResponseHeader('Authorization'));

							// if expired, request token refresh and then re-process th eoriginal request
							if (xhrRequest.status === 401 && output.status === 'expired') {
								if (!output.data || !output.data.refreshUrl) throw('You must specify a refresh URL with a JWT expiration, please return data.refreshUrl to enable auto JWT refresh');

								scope.get(output.data.refreshUrl).then(function() {
									scope.ajax(type, url, data, headers).then(function(response) {
										resolve({data: response.data, response: response.response});
									}).catch(function(response) {
										reject({data: response.data, response: response.response});
									});
								}).catch(function() {
									reject({data: output, response: xhrRequest});
								});
							}
							else if (xhrRequest.status === 200) resolve({data: output, response: xhrRequest});
							else reject({data: output, response: xhrRequest});
						}
					};
					xhrRequest.send(data);
				});
				return promise;
			}

			get(path, id) {
				var headers = {'Content-Type': 'application/json', 'Cache-Control': 'no-cache'};
				return this.ajax('GET', this._createEndPoint('/' + path + (typeof id !== 'undefined' && id !== null ? '/' + id : '')), null, headers);
			}

			put(path, data) {
				var headers = {'Content-Type': 'application/json', 'Cache-Control': 'no-cache'};
				try { data = JSON.stringify(data); }
				catch(e) {}
				return this.ajax('PUT', this._createEndPoint('/' + path), data, headers);
			}

			patch(path, data) {
				var headers = {'Content-Type': 'application/json', 'Cache-Control': 'no-cache'};
				try { data = JSON.stringify(data); }
				catch(e) {}
				return this.ajax('PATCH', this._createEndPoint('/' + path), data, headers);
			}

			post(path, data) {
				var headers = {'Content-Type': 'application/json', 'Cache-Control': 'no-cache'};
				try { data = JSON.stringify(data); }
				catch(e) {}
				return this.ajax('POST', this._createEndPoint('/' + path), data, headers);
			}

			delete(path, id) {
				var headers = {'Content-Type': 'application/json', 'Cache-Control': 'no-cache'};
				return this.ajax('DELETE', this._createEndPoint('/' + path + (typeof id !== 'undefined' && id !== null ? '/' + id : '')), null, headers);
			}

			getToken()
			{
				if (localStorage[!!this.id ? this.id : 'razilo' + '.authentication.jwt'] !== undefined) return localStorage[!!this.id ? this.id : 'razilo' + '.authentication.jwt'];

				return undefined;
			}

			setToken(value)
			{
				if (value === undefined) return false;

				return localStorage[!!this.id ? this.id : 'razilo' + '.authentication.jwt'] = value.replace('Bearer ', '').replace('Refresh ', '');
			}

			deleteToken()
			{
				localStorage[!!this.id ? this.id : 'razilo' + '.authentication.jwt'] = '';
			}
		}

		customElements.define(RaziloRequest.is, RaziloRequest);
	</script>
</dom-module>
